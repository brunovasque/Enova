name: Deploy nv-enova (Wrangler)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: nv-enova-deploy
  cancel-in-progress: true

jobs:
  deploy-prod:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Debug workspace (files + wrangler.toml)
        run: |
          echo "=== LS ==="
          ls -la
          echo "=== FIND suspicious txt ==="
          find . -maxdepth 5 -type f -name "*worker*.txt" -print || true
          echo "=== wrangler.toml ==="
          cat wrangler.toml
          echo "=== worker entry (from wrangler.toml main) ==="
          node -e "const fs=require('fs');const t=fs.readFileSync('wrangler.toml','utf8');const m=t.match(/^\s*main\s*=\s*\"([^\"]+)\"/m);console.log('main=',m?m[1]:'(not found)'); if(m&&fs.existsSync(m[1])){console.log('--- head ---'); console.log(fs.readFileSync(m[1],'utf8').split('\n').slice(0,25).join('\n'));} else {console.log('main file not found'); process.exit(2);} "

      - name: Ensure .env files exist (avoid ENOENT noise)
        run: |
          touch .env .env.test

      - name: Auth check
        run: |
          wrangler --version
          wrangler whoami

      - name: Deploy PROD (verbose)
        run: |
          WRANGLER_LOG=debug wrangler deploy --config wrangler.toml --keep-vars

  deploy-test:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Ensure .env files exist (avoid ENOENT noise)
        run: |
          touch .env .env.test

      - name: Debug secrets (safe)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo HAS_CLOUDFLARE_API_TOKEN
          else
            echo MISSING_CLOUDFLARE_API_TOKEN
          fi
          if [ -n "$CF_ACCOUNT_ID" ]; then
            echo HAS_CF_ACCOUNT_ID
          else
            echo MISSING_CF_ACCOUNT_ID
          fi
          echo "event=${{ github.event_name }}"
          echo "actor=${{ github.actor }}"
          echo "head_repo=${{ github.event.pull_request.head.repo.full_name || github.repository }}"
          echo "base_repo=${{ github.event.pull_request.base.repo.full_name || github.repository }}"

      - name: Deploy TEST (verbose)
        run: |
          WRANGLER_LOG=debug wrangler deploy --config wrangler.toml --env test --keep-vars

  worker-preview-pr:
    name: Worker Preview (PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Ensure .env files exist (avoid ENOENT noise)
        run: |
          touch .env .env.test

      - name: Debug secrets (safe)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo HAS_CLOUDFLARE_API_TOKEN
          else
            echo MISSING_CLOUDFLARE_API_TOKEN
          fi
          if [ -n "$CF_ACCOUNT_ID" ]; then
            echo HAS_CF_ACCOUNT_ID
          else
            echo MISSING_CF_ACCOUNT_ID
          fi
          echo "event=${{ github.event_name }}"
          echo "actor=${{ github.actor }}"
          echo "head_repo=${{ github.event.pull_request.head.repo.full_name || github.repository }}"
          echo "base_repo=${{ github.event.pull_request.base.repo.full_name || github.repository }}"

      - name: Deploy Worker Preview (TEST env)
        run: |
          WRANGLER_LOG=debug wrangler deploy --config wrangler.toml --env test --keep-vars
